<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>stereo-vision: SFM</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">stereo-vision
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SFM</div>  </div>
</div><!--header-->
<div class="contents">

<p>Structure From Motion (SFM) module for estimation of estrinsics parameter and computation of depth map.  
</p>
<p>Structure From Motion (SFM) module for estimation of estrinsics parameter and computation of depth map. </p>
<p>Copyright (C) 2015 RobotCub Consortium</p>
<p>Author: Sean Ryan Fanello, Giulia Pasquale</p>
<p>Date: first release around 24/07/2013</p>
<p>CopyPolicy: Released under the terms of the GNU GPL v2.0.</p>
<h1><a class="anchor" id="intro_sec"></a>
Description</h1>
<p>The module uses a complete Structure From Motion (SFM) pipeline for the computation of the extrinsics parameters between two different views. These parameters are then used to rectify the images and to compute a depth map using either the H. Hirschmuller Algorithm (CVPR 2006), implemented since Opencv 2.2, or <a href="http://www.cvlibs.net/software/libelas/">LIBELAS (Library for Efficient Large-scale Stereo Matching)</a>. The Kinematics of the iCub is used to guess the current camera positions, then visual features are used to refine this model. Before starting, make sure you have calibrated the intrinsics parameters. For the stereo calibration see the module <a href="http://wiki.icub.org/iCub/main/dox/html/group__icub__stereoCalib.html">stereoCalib</a>. This module provides six output ports: the first one is the disparity map in grayscale values, the second and the third port are the WorldImage, which are a 3-channels float images, where in each pixel are stored the three Cartesian and the Cylindrical coordinates with respect to robot root reference frame. The fourth port outputs the current keypoints match. Non valid points are handled with the special value (0,0,0). The last two ports output the rectified images used to compute the horizontal disparity map. In addition, a rpc port supports requests for 3D/2D points computation (see below).</p>
<dl class="section note"><dt>Note</dt><dd><b>If you're going to use this module for your work, please quote it within any resulting publication</b>: Fanello S.R., Pattacini U., Gori I., Tikhanoff V., Randazzo M., Roncone A., Odone F., Metta G., "3D Stereo Estimation and Fully Automated
      Learning of Eye-Hand Coordination in Humanoid Robots", <em>Proceedings of IEEE-RAS International Conference on Humanoid Robots</em>, Madrid, Spain, November 18-20, 2014.</dd></dl>
<h1><a class="anchor" id="lib_sec"></a>
Libraries</h1>
<p>YARP libraries and OpenCV 2.4 (at least). <br  />
For better performance, we suggest you to run the module on a machine equipped with GPU functionality along with the <a href="http://cs.unc.edu/~ccwu/siftgpu">SiftGPU</a> library installed. This module now uses <a href="http://www.cvlibs.net/software/libelas/">LIBELAS </a> by default to compute the horizontal disparity map from the rectified left and right images. The source code of LIBELAS is compiled with the stereoVisionLib (with no particular dependences). The OpenMP accelerated version of the LIBELAS is used under UNIX systems, if OpenMP is available.</p>
<h1><a class="anchor" id="parameters_sec"></a>
Parameters</h1>
<p>&ndash;name <em>SFM</em> </p><ul>
<li>The parameter <em>stemName</em> specifies the stem name of ports created by the module.</li>
</ul>
<p>&ndash;from <em>stereoCalibFile</em> </p><ul>
<li>The parameter <em>stereoCalibFile</em> specifies the stereo calibration file to configure the module with. Default is icubEyes.ini</li>
</ul>
<p>&ndash;context <em>stereoCalibContext</em> </p><ul>
<li>The parameter <em>stereoCalibContext</em> defines the YARP context to search for the stereo calibration file in. Default is cameraCalibration</li>
</ul>
<p>&ndash;robot <em>robotName</em> </p><ul>
<li>The parameter <em>robotName</em> specifies the name of the robot.</li>
</ul>
<p>&ndash;leftPort <em>/left</em>:i</p><ul>
<li>The parameter <em>inputLeft</em> specifies the left image input port.</li>
</ul>
<p>&ndash;rightPort <em>/right</em>:i</p><ul>
<li>The parameter <em>inputRight</em> specifies the right image input port.</li>
</ul>
<p>&ndash;outLeftRectImgPort <em>/rect_left</em>:o</p><ul>
<li>Specifies the left rectified image output port.</li>
</ul>
<p>&ndash;outRightRectImgPort <em>/rect_right</em>:o</p><ul>
<li>Specifies the right rectified image output port.</li>
</ul>
<p>&ndash;outDispPort <em>/disp</em>:o</p><ul>
<li>The parameter <em>/disparity</em>:o specifies the output port for the disparity image.</li>
</ul>
<p>&ndash;outMatchPort <em>/match</em>:o</p><ul>
<li>The parameter <em>/match</em>:o specifies the output port for the match image.</li>
</ul>
<p>&ndash;outWorldPort <em>/world</em> </p><ul>
<li>The parameter <em>/world</em> specifies the output suffix for the world images. The final tags <em>/cartesian</em>:o and <em>/cylindrical</em>:o are appended.</li>
</ul>
<p>&ndash;CommandPort <em>comm</em> </p><ul>
<li>The parameter <em>comm</em> specifies the command port for rpc protocol.</li>
</ul>
<p>&ndash;skipBLF</p><ul>
<li>Disable Bilateral filter.</li>
</ul>
<p>&ndash;use_sgbm</p><ul>
<li>By default LIBELAS is used to compute the disparity. However, if you prefer to continue using the OpenCV's SGBM algorithm, you just need to pass the parameter <em>use_sgbm</em>.</li>
</ul>
<p>If you use LIBELAS, there is the possibility of setting the following parameters:</p>
<p>&ndash;disp_scaling_factor <em>1.0</em> </p><ul>
<li>This parameter provides the option of resizing the left and right images before computing the disparity map (and finally resize again the resulting map to the original size). It is a multiplicative factor. For example, if a low-resolution (also less accurate!) disparity map is sufficient, but needed at high rate, you can set this parameter to 1/N so that the images width and height are divided by a factor N, LIBELAS computes the disparity of the downsampled images, and finally the disparity map's size is rescaled by N before returning.</li>
</ul>
<p>&ndash;elas_setting <em>ROBOTICS</em> </p><ul>
<li>The parameter <em>ROBOTICS</em> or <em>MIDDLEBURY</em> allow to choose between the two settings of parameters defined in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>. This module gives the possibility of modifying (eventually tuning to individual needs) those parameters which differ between the two settings, plus a couple of others (<em>elas_subsampling</em> and <em>elas_add_corners</em>). The remaining parameters are supposed to be fixed to the values proposed by the authors of LIBELAS.</li>
</ul>
<p>Here we list those LIBELAS parameters that can be passed to this module; see <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a> for the complete list of parameters, their definitions and default values.</p>
<p>&ndash;elas_subsampling</p><ul>
<li>Pass the parameter <em>elas_subsampling</em> if you want to set the <em>subsampling</em> parameter to <em>true</em> in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, to speedup the computation (at the expenses of accuracy).</li>
</ul>
<p>&ndash;elas_add_corners</p><ul>
<li>Pass the parameter <em>elas_add_corners</em> if you want to set <em>add_corners</em> parameter to <em>true</em> in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, to consider also the image corners in the computation of the disparity map.</li>
</ul>
<p>&ndash;elas_ipol_gap_width <em>40</em> </p><ul>
<li>This is the only parameter for which we set a default value different from the ones provided in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, where the <em>ipol_gap_width</em> parameter is set to <em>3</em> in <em>ROBOTICS</em> and <em>5000</em> in <em>MIDDLEBURY</em>. It is the radius of interpolation (in pixel) of the disparity values found in the keypoints. Small values result in sparser disparity maps (with more black holes); high values result in denser maps, with the black regions filled with interpolated values.</li>
</ul>
<p>Also the following LIBELAS parameters can be modified by the user, however we stick with the values provided by the authors.</p>
<p>&ndash;elas_support_threshold <em>0.85</em> </p><ul>
<li>This is the <em>support_threshold</em> parameter in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, set to 0.95 in <em>MIDDLEBURY</em> and 0.85 in <em>ROBOTICS</em>.</li>
</ul>
<p>&ndash;elas_gamma <em>3</em> </p><ul>
<li>This is the <em>gamma</em> parameter in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, set to 5 in <em>MIDDLEBURY</em> and 3 in <em>ROBOTICS</em>.</li>
</ul>
<p>&ndash;elas_sradius <em>2</em> </p><ul>
<li>This is the <em>sradius</em> parameter in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, set to 3 in <em>MIDDLEBURY</em> and 2 in <em>ROBOTICS</em>.</li>
</ul>
<p>&ndash;elas_match_texture <em>true</em> </p><ul>
<li>This is the <em>match_texture</em> parameter in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, set to <em>false</em> in <em>MIDDLEBURY</em> and <em>true</em> in <em>ROBOTICS</em>.</li>
</ul>
<p>&ndash;elas_filter_median <em>false</em> </p><ul>
<li>This is the <em>filter_median</em> parameter in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, set to <em>true</em> in <em>MIDDLEBURY</em> and <em>false</em> in <em>ROBOTICS</em>.</li>
</ul>
<p>&ndash;elas_filter_adaptive_mean <em>true</em> </p><ul>
<li>This is the <em>filter_adaptive_mean</em> parameter in <a href="https://github.com/robotology/stereo-vision/tree/master/lib/elas/include/elas.h">elas.h</a>, set to <em>false</em> in <em>MIDDLEBURY</em> and <em>true</em> in <em>ROBOTICS</em>.</li>
</ul>
<h1><a class="anchor" id="portsc_sec"></a>
Ports Created</h1>
<ul>
<li><em> /SFM/left:i </em> accepts the incoming images from the left eye.</li>
<li><em> /SFM/right:i </em> accepts the incoming images from the right eye.</li>
<li><em> /SFM/disp:o </em> outputs the disparity map in grayscale values.</li>
<li><em> /SFM/world/cartesian:o</em> outputs the world image (3-channel float with X Y Z values).</li>
<li><em> /SFM/world/cylindrical:o</em> outputs the world image (3-channel float with R Theta Z values).</li>
<li><em> /SFM/match:o</em> outputs the match image.</li>
<li><em> /SFM/rect_left:o</em> outputs the rectified left image.</li>
<li><em> /SFM/rect_right:o</em> outputs the rectified right image.</li>
<li><em> /SFM/rpc </em> for terminal commands communication.<ul>
<li>[calibrate]: It recomputes the camera positions once.</li>
<li>[save]: It saves the current camera positions and uses it when the module starts.</li>
<li>[getH]: It returns the calibrated stereo matrix.</li>
<li>[setNumDisp NumOfDisparities]: It sets the expected number of disparity (in pixel). Values must be divisible by 32. Good values are 64 for 320x240 images and 128 for 640x480 images.</li>
<li>[setMinDisp minDisparity]: It sets the minimum disparity (in pixel).</li>
<li>[Point x y]: Given the pixel coordinate x,y in the Left image the response is the 3D Point: X Y Z computed using the depth map wrt the LEFT eye. Points with non valid disparity (i.e. occlusions) are handled with the value (0.0,0.0,0.0).</li>
<li>[x y]: Given the pixel coordinate x,y in the Left image the response is the 3D Point: X Y Z ur vr computed using the depth map wrt the the ROOT reference system; (ur vr) is the corresponding pixel in the Right image. Points with non valid disparity (i.e. occlusions) are handled with the value (0.0,0.0,0.0).</li>
<li>[Left x y]: Given the pixel coordinate x,y in the Left image the response is the 3D Point: X Y Z computed using the depth map wrt the LEFT eye. Points with non valid disparity (i.e. occlusions) are handled with the value (0.0,0.0,0.0).</li>
<li>[Right x y]: Given the pixel coordinate x,y in the Left image the response is the 3D Point: X Y Z computed using the depth map wrt the RIGHT eye. Points with non valid disparity (i.e. occlusions) are handled with the value (0.0,0.0,0.0).</li>
<li>[Root x y]: Given the pixel coordinate x,y in the Left image the response is the 3D Point: X Y Z computed using the depth map wrt the ROOT reference system. Points with non valid disparity (i.e. occlusions) are handled with the value (0.0,0.0,0.0).</li>
<li>[Rect tlx tly w h step]: Given the pixels in the rectangle defined by {(tlx,tly) (tlx+w,tly+h)} (parsed by columns), the response contains the corresponding 3D points in the ROOT frame. The optional parameter step defines the sampling quantum; by default step=1.</li>
<li>[Points u_1 v_1 ... u_n v_n]: Given a list of n pixels, the response contains the corresponding 3D points in the ROOT frame.</li>
<li>[Flood3D x y dist]: Perform 3D flood-fill on the seed point (x,y), returning the following info: [u_1 v_1 x_1 y_1 z_1 ...]. The optional parameter dist expressed in meters regulates the fill (by default = 0.004).</li>
<li>[uL_1 vL_1 uR_1 vR_1 ... uL_n vL_n uR_n vR_n]: Given n quadruples uL_i vL_i uR_i vR_i, where uL_i vL_i are the pixel coordinates in the Left image and uR_i vR_i are the coordinates of the matched pixel in the Right image, the response is a set of 3D points (X1 Y1 Z1 ... Xn Yn Zn) wrt the ROOT reference system.</li>
<li>[cart2stereo X Y Z]: Given a world point X Y Z wrt to ROOT reference frame the response is the projection (uL vL uR vR) in the Left and Right images.</li>
<li>[doBLF flag]: activate Bilateral filter for flag = true, and skip it for flag = false (default by config).</li>
<li>[bilatfilt sigmaColor sigmaSpace]: Set the parameters for the bilateral filer (default sigmaColor = 10.0, sigmaSpace = 10.0 .</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="in_files_sec"></a>
Input Data Files</h1>
<p>None.</p>
<h1><a class="anchor" id="out_data_sec"></a>
Output Data Files</h1>
<p>None.</p>
<h1><a class="anchor" id="tested_os_sec"></a>
Tested OS</h1>
<p>Linux (Ubuntu 9.04, Debian Squeeze) and Windows 7. Tested against OpenCV versions: 2.4.</p>
<dl class="section author"><dt>Author</dt><dd>Sean Ryan Fanello, Giulia Pasquale </dd></dl>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
